version: '3'
services:
  game_controller:
    build:
      context: ./game_controller
      dockerfile: Dockerfile
    ports:
      - "5002:5002"
    depends_on:
      otelcol:
        condition: service_started
      rolling:
        condition: service_healthy
      scoring:
        condition: service_healthy
    environment:
      # OTEL_SERVICE_NAME sets the service.name resource attribute, which maps
      # directly to the Datadog APM service name.
      - OTEL_SERVICE_NAME=game-controller
      # OTEL_EXPORTER_OTLP_ENDPOINT configures where the SDK sends traces/metrics.
      # This points to the OTel Collector running as a sidecar in this compose setup.
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otelcol:4317
      - OTEL_EXPORTER_OTLP_PROTOCOL=grpc
      # W3C TraceContext is the default propagator; set explicitly for clarity.
      - OTEL_PROPAGATORS=tracecontext,baggage
      # Enable log auto-instrumentation for log-trace correlation in Datadog.
      - OTEL_LOG_LEVEL=info
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'

  rolling:
    build:
      context: ./rolling
      dockerfile: Dockerfile
    ports:
      - "5004:5004"
    depends_on:
      otelcol:
        condition: service_started
    environment:
      - OTEL_SERVICE_NAME=rolling
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otelcol:4317
      - OTEL_EXPORTER_OTLP_PROTOCOL=grpc
      - OTEL_PROPAGATORS=tracecontext,baggage
      # Enable Python logging auto-instrumentation to inject trace context into logs.
      - OTEL_PYTHON_LOGGING_AUTO_INSTRUMENTATION_ENABLED=true
      - OTEL_PYTHON_LOG_CORRELATION=true
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'

  scoring:
    build:
      context: ./scoring
      dockerfile: Dockerfile
    ports:
      - "5001:5001"
    depends_on:
      otelcol:
        condition: service_started
    environment:
      - OTEL_SERVICE_NAME=scoring
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otelcol:4317
      - OTEL_EXPORTER_OTLP_PROTOCOL=grpc
      - OTEL_PROPAGATORS=tracecontext,baggage
      - OTEL_PYTHON_LOGGING_AUTO_INSTRUMENTATION_ENABLED=true
      - OTEL_PYTHON_LOG_CORRELATION=true
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'

  otelcol:
    image: otel/opentelemetry-collector-contrib:latest
    restart: unless-stopped
    command: ["--config=/etc/otelcol-config.yml"]
    volumes:
      - ./config.yml:/etc/otelcol-config.yml
    ports:
      - "4317:4317" # OTLP gRPC receiver
      - "4318:4318" # OTLP HTTP receiver
    environment:
      # DD_API_KEY is required for the Datadog exporter.
      # Set it in a .env file or export it before running docker compose.
      - DD_API_KEY=${DD_API_KEY}
      # DD_SITE defaults to datadoghq.com; override for EU or other sites.
      - DD_SITE=${DD_SITE:-datadoghq.com}
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
