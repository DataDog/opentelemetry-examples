services:
  zookeeper-otel:
    image: confluentinc/cp-zookeeper:7.7.1
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - 22181:2181
    healthcheck:
      test: echo ruok | nc localhost 2181 | grep imok
      start_period: 10s
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"
        reservations:
          memory: 256M

  kafka-otel:
    image: confluentinc/cp-kafka:7.7.1
    depends_on:
      zookeeper-otel:
        condition: service_healthy
    ports:
      - 29092:29092
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper-otel:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka-otel:9092,PLAINTEXT_HOST://localhost:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    healthcheck:
      test: kafka-broker-api-versions --bootstrap-server localhost:9092
      start_period: 20s
      interval: 10s
      timeout: 10s
      retries: 10
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "1.0"
        reservations:
          memory: 512M

  words-producer-java-otel:
    depends_on:
      kafka-otel:
        condition: service_healthy
      datadog-agent-kafka-otel:
        condition: service_healthy
    container_name: words-producer-java-otel
    build:
      context: .
      dockerfile: Dockerfile.words.java.otel
    environment:
      - OTEL_SERVICE_NAME=words-producer-java-otel
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://datadog-agent-kafka-otel:4317
      - OTEL_EXPORTER_OTLP_PROTOCOL=grpc
      - OTEL_RESOURCE_ATTRIBUTES=deployment.environment=otel-kafka,host.name=otelcol-docker
      - SERVER_PORT=9090
      - KAFKA_SERVERS=kafka-otel:9092
    ports:
      - "9090:9090"
    healthcheck:
      test: curl -f http://localhost:9090/actuator/health || exit 1
      start_period: 30s
      interval: 15s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 768M
          cpus: "1.0"
        reservations:
          memory: 384M
    restart: on-failure

  words-consumer-go-otel:
    depends_on:
      kafka-otel:
        condition: service_healthy
      datadog-agent-kafka-otel:
        condition: service_healthy
    container_name: words-consumer-go-otel
    build:
      context: .
      dockerfile: Dockerfile.words.go.otel
    environment:
      - OTEL_SERVICE_NAME=words-consumer-go-otel
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://datadog-agent-kafka-otel:4317
      - OTEL_RESOURCE_ATTRIBUTES=deployment.environment=otel-kafka,host.name=otelcol-docker
      - KAFKA_SERVERS=kafka-otel:9092
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.5"
        reservations:
          memory: 128M
    restart: on-failure

  datadog-agent-kafka-otel:
    container_name: datadog-agent-kafka-otel
    image: "gcr.io/datadoghq/agent:7"
    pid: host
    ports:
      - 8125:8125
      - 8126:8126
      - 4317:4317
      - 4318:4318
    environment:
      - DD_API_KEY=${DD_API_KEY}
      - DD_SITE=${DD_SITE:-datadoghq.com}
      - DD_APM_NON_LOCAL_TRAFFIC=true
      - DD_DOGSTATSD_NON_LOCAL_TRAFFIC=true
      - DD_OTLP_CONFIG_RECEIVER_PROTOCOLS_GRPC_ENDPOINT=0.0.0.0:4317
      - DD_OTLP_CONFIG_RECEIVER_PROTOCOLS_HTTP_ENDPOINT=0.0.0.0:4318
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /proc/:/host/proc/:ro
      - /sys/fs/cgroup:/host/sys/fs/cgroup:ro
    healthcheck:
      test: agent health
      start_period: 15s
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "1.0"
        reservations:
          memory: 512M
    restart: unless-stopped
